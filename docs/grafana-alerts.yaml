apiVersion: 1

groups:
  - orgId: 1
    name: mvpforge-api-alerts
    folder: MVPForge
    interval: 1m
    rules:
      - uid: high-latency
        title: High latency p95
        condition: A
        data:
          - refId: A
            datasourceUid: prometheus
            queryType: timeSeriesQuery
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expr: histogram_quantile(0.95, sum by (le) (rate(http_response_time_ms_bucket[$__rate_interval]))) > 500
              interval: "$__interval"
              legendFormat: p95
              refId: A
        for: 5m
        annotations:
          summary: p95 latency over 500ms for 5m
        labels:
          severity: warning
      - uid: high-error-rate
        title: High error rate (>2%)
        condition: A
        data:
          - refId: A
            datasourceUid: prometheus
            queryType: timeSeriesQuery
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expr: 100 * (sum(rate(http_responses_total{status=~"5.."}[5m])) / sum(rate(http_responses_total[5m]))) > 2
              interval: "$__interval"
              refId: A
        for: 5m
        annotations:
          summary: Error rate above 2% for 5 minutes
        labels:
          severity: critical
      - uid: high-cpu
        title: High CPU usage
        condition: A
        data:
          - refId: A
            datasourceUid: prometheus
            queryType: timeSeriesQuery
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expr: (rate(process_cpu_user_seconds_total[5m]) + rate(process_cpu_system_seconds_total[5m])) > 0.7
              interval: "$__interval"
              refId: A
        for: 5m
        annotations:
          summary: CPU usage above ~70% (approx) for 5 minutes
        labels:
          severity: warning
      - uid: high-memory
        title: High memory RSS
        condition: A
        data:
          - refId: A
            datasourceUid: prometheus
            queryType: timeSeriesQuery
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expr: process_resident_memory_bytes > 800000000
              interval: "$__interval"
              refId: A
        for: 5m
        annotations:
          summary: Memory RSS above ~800MB
        labels:
          severity: warning
